<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Search | Advanced Search Engine</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="search-container">
        <div class="logo">Quantum<span>Search</span></div>
        <div class="tagline">Discover the universe of information with our advanced search technology</div>
        
        <div class="search-box">
            <input type="text" id="searchQuery" class="search-input" 
                   placeholder="Search for anything..." autocomplete="off" autofocus>
            <button class="search-btn" onclick="performSearch()">
                <i class="fas fa-search"></i>
            </button>
        </div>
        
        <div class="controls">
            <div class="toggle-container">
                <label class="toggle-switch">
                    <input type="checkbox" id="pagerankToggle">
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label">Use PageRank Algorithm</span>
            </div>
            
            <div class="search-tips-toggle" onclick="toggleTips()">
                <i class="fas fa-lightbulb"></i> Search Tips
            </div>
        </div>
        
        <div id="searchInfo" class="search-info"></div>
        <div id="searchResults"></div>
        
        <div class="search-tips" id="searchTips" style="display: none;">
            <div class="search-tips-title">
                <i class="fas fa-info-circle"></i> Search Tips
            </div>
            <ul class="search-tips-list">
                <li>Use quotes (" ") to search for exact phrases</li>
                <li>Try different keywords if you don't find what you're looking for</li>
                <li>Toggle PageRank to prioritize authoritative pages</li>
                <li>Keep your search terms simple and specific</li>
            </ul>
        </div>
    </div>

    <script>
        // Initialize random tagline
        const quotes = [
            "The only way to discover the limits of the possible is to go beyond them into the impossible.",
            "Information is not knowledge. The only source of knowledge is experience.",
            "The most exciting phrase to hear in science, the one that heralds new discoveries, is not 'Eureka!' but 'That's funny...'",
            "The important thing is not to stop questioning. Curiosity has its own reason for existing."
        ];
        document.querySelector('.tagline').textContent = quotes[Math.floor(Math.random() * quotes.length)];

        let currentPage = 1;

        function performSearch(page = 1) {
            const query = document.getElementById("searchQuery").value.trim();
            if (!query) {
                showError("Please enter a search query to begin!");
                return;
            }

            showLoading();
            document.getElementById("searchTips").style.display = "none";
            currentPage = page;

            fetch(`/search?q=${encodeURIComponent(query)}&pagerank=${document.getElementById("pagerankToggle").checked}&page=${page}&page_size=10`)
                .then(response => response.json())
                .then(data => displayResults(data, query))
                .catch(error => showError(error.message));
        }


        function displayResults(data, query) {
            const resultsDiv = document.getElementById("searchResults");
            const infoDiv = document.getElementById("searchInfo");

            if (data.error) {
                resultsDiv.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i> ${data.error}</div>`;
                return;
            }

            if (data.special_thanks) {
                infoDiv.innerHTML = `<div>Special thanks to our professors and TAs</div>`;
                resultsDiv.innerHTML = `
                    <div class="special-thanks">
                        <h2><i class="fas fa-heart"></i> Special Thanks</h2>
                        <div class="names">${data.names.map(name => `<strong>${escapeHtml(name)}</strong>`).join('<br>')}</div>
                        <div class="message">${escapeHtml(data.message)}</div>
                    </div>
                `;
                return;
            }

            infoDiv.innerHTML = `
                <div>Found <strong>${data.count}</strong> results in <strong>${data.time.toFixed(2)}</strong> seconds</div>
                <div>Search query: <strong>"${escapeHtml(data.query)}"</strong></div>
            `;

            if (data.count === 0) {
                resultsDiv.innerHTML = `<div class="no-results"><i class="fas fa-search"></i> No results found</div>`;
                return;
            }

            let html = "";
            data.results.forEach((result, index) => {
                const termCountsHtml = Object.entries(result.term_counts)
                    .map(([term, count]) => `<div class="term-count-item"><span class="term">${escapeHtml(term)}</span>: <span class="count">${count}</span></div>`)
                    .join("");

                html += `
                    <div class="result-item">
                        <div class="result-title"><a href="${result.url}" target="_blank">${escapeHtml(result.title)}</a></div>
                        <div class="result-url"><a href="${result.url}" target="_blank">${truncateUrl(result.url)}</a></div>
                        <div class="result-snippet">${result.content_snippet || "No preview available"}</div>
                        <div class="term-counts-container">
                            <div class="term-counts-title">Term frequencies:</div>
                            <div class="term-counts-grid">${termCountsHtml}</div>
                        </div>
                        <div class="result-meta">
                            ${result.pagerank_score ? `<div class="meta-item"><i class="fas fa-chart-line"></i> Authority: ${result.pagerank_score.toFixed(2)}</div>` : ""}
                            <div class="meta-item"><i class="fas fa-hashtag"></i> Result ${index + 1 + ((data.page - 1) * 10)}</div>
                        </div>
                    </div>
                `;
            });

            // Pagination controls
            html += `
                <div class="pagination-controls">
                    <button id='btn-move' ${data.page <= 1 ? "disabled" : ""} onclick="performSearch(${data.page - 1})">← Previous</button>
                    <span>Page ${data.page} of ${data.total_pages}</span>
                    <button id='btn-move' ${data.page >= data.total_pages ? "disabled" : ""} onclick="performSearch(${data.page + 1})">Next →</button>
                </div>
            `;

            resultsDiv.innerHTML = html;
        }


        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function truncateUrl(url, maxLength = 60) {
            if (url.length <= maxLength) return url;
            const parsed = new URL(url);
            return parsed.hostname + (parsed.pathname.length > maxLength/2 ? 
                   parsed.pathname.substring(0, maxLength/2) + '...' : 
                   parsed.pathname);
        }

        function showError(message) {
            document.getElementById("searchResults").innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                </div>
            `;
        }

        function showLoading() {
            document.getElementById("searchResults").innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Searching the quantum realm...</div>
                </div>
            `;
        }

        function toggleTips() {
            const tips = document.getElementById("searchTips");
            tips.style.display = tips.style.display === "none" ? "block" : "none";
        }

        document.getElementById("searchQuery").addEventListener("keyup", function(event) {
            if (event.key === "Enter") performSearch();
        });

        const searchBtn = document.querySelector('.search-btn');
        searchBtn.addEventListener('mouseenter', () => {
            searchBtn.innerHTML = '<i class="fas fa-rocket"></i>';
        });
        searchBtn.addEventListener('mouseleave', () => {
            searchBtn.innerHTML = '<i class="fas fa-search"></i>';
        });
    </script>
</body>
</html>